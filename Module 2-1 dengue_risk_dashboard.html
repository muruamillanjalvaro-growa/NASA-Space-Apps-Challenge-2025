<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Resilience Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #162447;
            --primary-color: #e43f5a;
            --accent-color: #4a569d;
            --text-color: #f0f4f7;
            --risk-low: #28a745;
            --risk-medium: #ffc107;
            --risk-high: #dc3545;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        .dashboard-container {
            background-color: var(--card-color);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
        }

        .form-section h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .form-section p {
            font-weight: 300;
            color: var(--text-color);
            margin-bottom: 25px;
        }
        
        .location-display {
            font-size: 0.8em;
            color: #a0a0b0;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-color);
        }
        
        .label-with-info {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative; /* For tooltip positioning */
        }

        .info-icon-input {
            cursor: help;
            color: #a0a0b0;
        }
        
        .tooltip-input {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            font-weight: 400;
        }

        .label-with-info:hover .tooltip-input {
            visibility: visible;
            opacity: 1;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            background-color: #162447;
            color: var(--text-color);
            box-sizing: border-box;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        select {
             -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23f0f4f7' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 8px rgba(228, 63, 90, 0.5);
        }

        .submit-btn {
            background-color: var(--primary-color);
            color: var(--text-color);
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.2s ease;
            position: relative;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: #b33045;
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        .result-section {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            text-align: left;
            position: relative;
        }
        
        #result-display {
            width: 100%;
            background-color: #212c4f;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        #riskLevelText {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        #riskScoreContainer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        #riskScore {
            font-size: 3em;
            font-weight: 700;
        }
        
        #riskScore .risk-unit {
            font-size: 0.5em;
            font-weight: 400;
        }

        #riskGauge {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(var(--risk-low) 0% 33%, var(--risk-medium) 33% 66%, var(--risk-high) 66% 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite ease-in-out;
        }

        #riskGauge:after {
            content: '';
            width: 65px;
            height: 65px;
            background-color: #1a1a2e;
            border-radius: 50%;
            position: absolute;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 10px rgba(228, 63, 90, 0.5); }
            50% { box-shadow: 0 0 20px rgba(228, 63, 90, 0.8); }
        }

        .accordion-item { border-bottom: 1px solid var(--accent-color); }
        .accordion-header {
            background-color: var(--accent-color);
            color: var(--text-color);
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .accordion-header:hover { background-color: #3b457e; }
        .accordion-content {
            padding: 15px;
            background-color: #212c4f;
            display: none;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.active { display: block; }
        .accordion-content ul { list-style-type: none; padding: 0; margin: 0; }
        .accordion-content li { margin-bottom: 10px; color: #a0a0b0; font-size: 0.9em; }
        .accordion-icon { transition: transform 0.3s ease; }
        .accordion-icon.rotate { transform: rotate(180deg); }

        .report-title-container { display: flex; align-items: center; gap: 10px; position: relative; }
        .info-icon { cursor: help; color: #a0a0b0; }
        .tooltip {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
            font-weight: 400;
            font-family: 'Poppins';
        }
        .info-icon:hover .tooltip { visibility: visible; opacity: 1; }

        .climate-card {
            background-color: #212c4f;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        .climate-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .climate-metric .value { font-size: 1.2em; font-weight: 600; color: var(--text-color); }
        .climate-metric .label-icon { font-size: 0.9em; color: #a0a0b0; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;}
        .climate-card h3 { margin-bottom: 15px; text-align: center; font-size: 1.1em;}
        .gauge { width: 100%; background-color: #1a1a2e; border-radius: 5px; height: 10px; overflow: hidden; margin-bottom: 5px; }
        .gauge-bar { height: 100%; border-radius: 5px; transition: width 0.5s ease-out; }
        #temp-gauge-bar { background: linear-gradient(90deg, var(--risk-medium), var(--risk-high)); }
        #humidity-gauge-bar { background: linear-gradient(90deg, var(--accent-color), var(--risk-low)); }
        .metric-details { display: flex; justify-content: space-between; align-items: center; }

    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="form-section">
            <h1>Sociodemographic Impact Model</h1>
            <p>Analyze and forecast dengue risk based on community demographics and local infrastructure conditions.</p>
            <div id="location-display" class="location-display">
                <i class="fas fa-map-marker-alt"></i> Detecting location...
            </div>
            <form id="dengueForm">
                <div class="label-with-info">
                    <label for="community_profile">Community Profile</label>
                    <div class="info-icon-input">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-input">Select the profile that best describes the area.</span>
                    </div>
                </div>
                <div class="form-group">
                    <select id="community_profile" name="community_profile" required>
                        <option value="0.1">Rural Dispersed</option>
                        <option value="0.3">Low-Density Suburban</option>
                        <option value="0.6" selected>Medium-Density Urban</option>
                        <option value="0.8">High-Density Urban</option>
                        <option value="1.0">Dense & Unplanned Settlement</option>
                    </select>
                </div>

                <div class="label-with-info">
                    <label>Infrastructure & Environment</label>
                     <div class="info-icon-input">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-input">Scale from 1 (optimal) to 10 (deficient).</span>
                    </div>
                </div>
                <div class="form-group">
                    <input type="number" id="solid_waste" name="solid_waste" placeholder="Solid Waste (1=Good, 10=Bad)" min="1" max="10" required>
                </div>
                <div class="form-group">
                    <input type="number" id="drainage_level" name="drainage_level" placeholder="Drainage Level (1=Good, 10=Bad)" min="1" max="10" required>
                </div>

                <button type="submit" id="submitBtn" class="submit-btn">Generate Risk Report</button>
            </form>
        </div>

        <div class="result-section">
            <div class="report-title-container">
                <h2 id="reportTitle">Dengue Risk Report</h2>
                <div class="info-icon">
                    <i class="fas fa-info-circle"></i>
                    <span class="tooltip">This is a normalized risk index from 0% (lowest risk) to 100% (highest risk), based on sociodemographic and climatic factors.</span>
                </div>
            </div>
            <div id="result-display">
                <div id="riskScoreContainer">
                    <span id="riskScore">--<span class="risk-unit">%</span></span>
                    <div id="riskGauge"></div>
                </div>
                <p id="riskLevelText">Enter data to generate report</p>
            </div>

            <div id="climate-container" class="climate-card" style="display: none;">
                 <h3><i class="fas fa-cloud-sun-rain"></i> Local Climate Factors (90-Day Avg)</h3>
                 <div class="climate-grid">
                     <div class="climate-metric">
                        <div class="label-icon"><i class="fas fa-thermometer-half"></i> Avg. Temperature</div>
                        <div class="gauge">
                            <div class="gauge-bar" id="temp-gauge-bar"></div>
                        </div>
                        <div class="metric-details">
                            <span id="avg-temp" class="value">--°C</span>
                        </div>
                     </div>
                     <div class="climate-metric">
                        <div class="label-icon"><i class="fas fa-tint"></i> Avg. Humidity</div>
                        <div class="gauge">
                            <div class="gauge-bar" id="humidity-gauge-bar"></div>
                        </div>
                         <div class="metric-details">
                            <span id="avg-humidity" class="value">--%</span>
                        </div>
                     </div>
                 </div>
            </div>
            
            <div id="report-accordion">
                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Risk Breakdown</span>
                        <i class="fas fa-chevron-down accordion-icon"></i>
                    </div>
                    <div id="breakdown-content" class="accordion-content">
                        <ul id="breakdownList">
                            <li>Please provide input data to see a detailed analysis.</li>
                        </ul>
                    </div>
                </div>

                <div class="accordion-item">
                    <div class="accordion-header">
                        <span>Recommended Actions</span>
                        <i class="fas fa-chevron-down accordion-icon"></i>
                    </div>
                    <div id="recommendations-content" class="accordion-content">
                        <ul id="recommendationsList">
                            <li>Generate report to view recommendations.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Core Model Logic ---
        function predictRisk(features, demographicFactor, climateFactor) {
            const means = {
                solid_waste: 5.0, drainage_level: 5.0, climate_factor: 0.5, demographic_factor: 0.5
            };
            const stds = {
                 solid_waste: 2.0, drainage_level: 2.0, climate_factor: 0.2, demographic_factor: 0.3
            };

            const normalizedFeatures = {
                solid_waste: (features.solid_waste - means.solid_waste) / stds.solid_waste,
                drainage_level: (features.drainage_level - means.drainage_level) / stds.drainage_level,
                demographic_factor: (demographicFactor - means.demographic_factor) / stds.demographic_factor,
                climate_factor: (climateFactor - means.climate_factor) / stds.climate_factor
            };

            const infrastructureRisk = Math.max(0, normalizedFeatures.solid_waste * 3.5 + normalizedFeatures.drainage_level * 3.5 + 0.5);
            const demographicVulnerability = Math.max(0, normalizedFeatures.demographic_factor * 4.0 + 0.2);
            const environmentalImpact = Math.max(0, normalizedFeatures.climate_factor * 4.5 + (normalizedFeatures.demographic_factor * 0.5) + 0.1);

            const finalPrediction = (
                infrastructureRisk * 0.40 + 
                demographicVulnerability * 0.25 +
                environmentalImpact * 0.35
            );

            return Math.min(100, Math.max(0, finalPrediction * 10)); 
        }

        // --- UI & Report Logic ---
        const form = document.getElementById('dengueForm');
        const submitBtn = document.getElementById('submitBtn');
        const locationDisplay = document.getElementById('location-display');
        const riskGauge = document.getElementById('riskGauge');
        const riskScoreEl = document.getElementById('riskScore');
        const riskLevelTextEl = document.getElementById('riskLevelText');
        const breakdownListEl = document.getElementById('breakdownList');
        const recommendationsListEl = document.getElementById('recommendationsList');
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        const climateContainer = document.getElementById('climate-container');

        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Analyzing...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Risk Report';
            }
        }

        function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.warn("Geolocation is not supported by this browser.");
                    resolve({ lat: 19.43, lon: -99.13, name: "Mexico City, MX (Default)" });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const coords = { lat: position.coords.latitude, lon: position.coords.longitude };
                        const name = await getCityName(coords);
                        resolve({ ...coords, name });
                    },
                    () => {
                        console.warn(`Geolocation error.`);
                        resolve({ lat: 19.43, lon: -99.13, name: "Mexico City, MX (Default)" });
                    }
                );
            });
        }

        async function getCityName({ lat, lon }) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const data = await response.json();
                return `${data.city}, ${data.principalSubdivisionCode.replace('MX-','')}`;
            } catch (e) { return "Current Location"; }
        }

        async function fetchClimateData({ lat, lon }) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 90);
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            
            const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${formatDate(startDate)}&end_date=${formatDate(endDate)}&daily=temperature_2m_mean,relativehumidity_2m_mean`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const temps = data.daily.temperature_2m_mean.filter(t => t !== null);
                const humidities = data.daily.relativehumidity_2m_mean.filter(h => h !== null);
                
                const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;
                const avgHumidity = humidities.reduce((a, b) => a + b, 0) / humidities.length;
                
                return { avgTemp, avgHumidity };
            } catch (error) {
                console.error("Failed to fetch climate data:", error);
                return { avgTemp: 25, avgHumidity: 70, error: true }; // Return default values on error
            }
        }

        function calculateClimateFactor({ avgTemp, avgHumidity }) {
            const tempScore = Math.min(1, Math.max(0, (avgTemp - 20) / 15));
            const humidityScore = Math.min(1, Math.max(0, (avgHumidity - 50) / 40));
            return (tempScore * 0.6) + (humidityScore * 0.4);
        }

        function renderClimateData({ avgTemp, avgHumidity }) {
            document.getElementById('avg-temp').textContent = `${avgTemp.toFixed(1)}°C`;
            document.getElementById('avg-humidity').textContent = `${avgHumidity.toFixed(1)}%`;
            
            const tempGaugeBar = document.getElementById('temp-gauge-bar');
            const humidityGaugeBar = document.getElementById('humidity-gauge-bar');

            const tempPercent = Math.min(100, Math.max(0, (avgTemp / 40) * 100));
            const humidityPercent = Math.min(100, Math.max(0, avgHumidity));

            tempGaugeBar.style.width = `${tempPercent}%`;
            humidityGaugeBar.style.width = `${humidityPercent}%`;

            climateContainer.style.display = 'block';
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = `${Math.floor(progress * (end - start) + start)}<span class="risk-unit">%</span>`;
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            setLoading(true);

            const location = await getUserLocation();
            locationDisplay.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${location.name}`;
            
            const climateData = await fetchClimateData(location);
            const climateFactor = calculateClimateFactor(climateData);

            const demographicFactor = parseFloat(document.getElementById('community_profile').value);
            const features = {
                solid_waste: parseFloat(document.getElementById('solid_waste').value),
                drainage_level: parseFloat(document.getElementById('drainage_level').value),
            };

            const riskScoreValue = predictRisk(features, demographicFactor, climateFactor);
            const riskCategory = getRiskCategory(riskScoreValue);
            const riskColor = getRiskColor(riskCategory);

            animateValue(riskScoreEl, 0, parseInt(riskScoreValue), 1000);
            riskLevelTextEl.textContent = `${riskCategory} Risk Level`;
            riskLevelTextEl.style.color = riskColor;
            riskGauge.style.background = `conic-gradient(${riskColor} ${riskScoreValue}%, var(--accent-color) ${riskScoreValue}% 100%)`;

            renderClimateData(climateData);
            updateReport(riskScoreValue, features, demographicFactor, climateFactor > 0.7);
            setLoading(false);
        });

        accordionHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.accordion-icon');
                content.classList.toggle('active');
                icon.classList.toggle('rotate');
            });
        });

        function getRiskCategory(score) {
            if (score <= 33) return 'Low';
            if (score <= 66) return 'Moderate';
            return 'High';
        }

        function getRiskColor(category) {
            if (category === 'Low') return 'var(--risk-low)';
            if (category === 'Moderate') return 'var(--risk-medium)';
            return 'var(--risk-high)';
        }

        function updateReport(score, features, demographicFactor, highClimateRisk) {
            const poorDrainage = features.drainage_level > 7;
            const highWaste = features.solid_waste > 7;
            const highDemographicRisk = demographicFactor >= 0.8;

            const breakdownItems = [];
            if (poorDrainage) breakdownItems.push("Infrastructure Risk: Poor drainage is a major contributor to mosquito breeding grounds.");
            if (highWaste) breakdownItems.push("Infrastructure Risk: High solid waste levels provide additional breeding sites and shelter for mosquitoes.");
            if (highDemographicRisk) breakdownItems.push("Demographic Vulnerability: The selected community profile (high density / unplanned) increases the speed of disease transmission.");
            if (highClimateRisk) breakdownItems.push("Environmental Risk: Recent climate conditions (high temp/humidity) are highly favorable for the mosquito life cycle.");

            breakdownListEl.innerHTML = breakdownItems.length > 0 
                ? breakdownItems.map(item => `<li>${item}</li>`).join('')
                : '<li>All indicators suggest low contributing factors.</li>';

            const recommendations = [];
            recommendationsListEl.innerHTML = '';

            if (score <= 33) {
                recommendations.push("Continue routine monitoring and maintenance of public services to prevent future risk.");
                recommendations.push("Promote community engagement and education programs to maintain clean spaces.");
            } else if (score <= 66) {
                if (poorDrainage) recommendations.push("Conduct targeted inspections and repairs of drainage systems in the area.");
                if (highWaste) recommendations.push("Increase solid waste collection frequency and implement waste management education campaigns.");
                if (highDemographicRisk || highClimateRisk) recommendations.push("Launch public health campaigns focused on preventing mosquito breeding in high-risk areas.");
            } else {
                if (poorDrainage) recommendations.push("Urgent inspection and rehabilitation of critical drainage infrastructure.");
                if (highWaste) recommendations.push("Emergency cleanup operations and immediate increase of waste collection services.");
                if (highDemographicRisk) recommendations.push("Deploy mobile health units for dengue detection and treatment in high-risk communities.");
                if (highClimateRisk) recommendations.push("Consider targeted fumigation in areas with consistently high climate risk.");
                recommendations.push("Establish an emergency response plan in coordination with health authorities.");
            }
            
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsListEl.appendChild(li);
            });
        }
        
        // Initial location fetch
        getUserLocation().then(location => {
            locationDisplay.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${location.name}`;
        });

    </script>
</body>
</html>

